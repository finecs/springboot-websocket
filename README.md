# 交友聊天（后台）

摘 要：本项目设计的聊天室基于Java Web平台，采用MySQL数据库、WebSocket协议、jQuery框架，实现了用户登录注册，用户群聊，发送表情包、上传文件功能等功能，能够在网络环境下运行，并具备动态网页。经测试，程序能正常运行，实现了以上设计目标。

关键词：即时通信、MySQL数据库、WebSocket协议、SpringBoot框架

## 引 言

### 本文主要内容

本文针对如何设计一个网络聊天室进行了研究。本项目基于Spring Boot框架和Websocket协议。前实现了用户登录、注册功能，群聊，上传文件，发送表情包，实时更新在线人数、动态更新用户列表，实时确定消息发送时间等功能。

本文第二节介绍了FW网络聊天室的设计原理和主要技术；第三节包括该聊天室的可行性分析、需求分析、总体设计、详细设计及测试结果；第四节指出了设计中的问题和解决问题的方法以及本系统的优点和不足之处。

### 设计原理

WebSocket协议

HTTP 协议有一个缺陷：通信只能由客户端发起，HTTP 协议做不到服务器主动向客户端推送信息。

WebSocket协议是基于TCP的一种新的网络协议。它实现了浏览器与服务器全双工(full-duplex)通信——允许服务器主动发送信息给客户端。

![https://www.runoob.com/wp-content/uploads/2016/03/ws.png](https://www.runoob.com/wp-content/uploads/2016/03/ws.png)

  WebSocket用于在Web浏览器和服务器之间进行任意的双向数据传输的一种技术。WebSocket协议基于TCP协议实现，包含初始的握手过程，以及后续的多次数据帧双向传输过程。其目的是在WebSocket应用和WebSocket服务器进行频繁双向通信时，可以使服务器避免打开多个HTTP连接进行工作来节约资源，提高了工作效率和资源利用率。WebSocket技术的优点有：

1. 通过第一次HTTP Request建立了连接之后，后续的数据交换都不用再重新发送HTTP Request，节省了带宽资源； 
2. WebSocket的连接是双向通信的连接，在同一个TCP连接上，既可以发送，也可以接收; 
3. 具有多路复用的功能(multiplexing)，也即几个不同的URI可以复用同一个WebSocket连接。这些特点非常类似TCP连接，但是因为它借用了HTTP协议的一些概念，所以被称为了WebSocket。

SpringBoot框架

Spring Boot是一个简化Spring开发的框架。用来监护spring应用开发，约定大于配置，去繁就简，just run 就能创建一个独立的，产品级的应用。我们在使用Spring Boot时只需要配置相应的Spring Boot就可以用所有的Spring组件，简单的说，spring boot就是整合了很多优秀的框架，不用我们自己手动的去写一堆xml配置然后进行配置。从本质上来说，Spring Boot就是Spring,它做了那些没有它你也会去做的Spring Bean配置。

本项目采用最新的Spring boot 2。

JavaScript

  是一种直译式脚本语言，是一种动态类型、弱类型、基于原型的语言，内置支持类型。它的解释器被称为JavaScript引擎，为浏览器的一部分，广泛用于客户端的脚本语言，是在HTML网页上使用，用来给HTML网页增加动态功能。

MySQL数据库

  MySQL是一种开放源代码的关系型数据库管理系统（RDBMS），使用最常用的数据库管理语言--结构化查询语言（SQL）进行数据库管理。MySQL是开放源代码的，因此任何人都可以在General Public License的许可下下载并根据个性化的需要对其进行修改。MySQL因为其速度、可靠性和适应性而备受关注

### 设计步骤

#### 系统分析与总体设计

##### 可行性分析

   （1）法律可行性：所有软件都选用正版，版权归开发者所有。

   （2）技术可行性：本人缺乏web开发经验，但是在本学期的课程中掌握了知识要点，独立完成过模仿百度、京东等网站。在此之前熟练运用idea开发环境。并且通过为期一周的培训深入了解了JavaScript技术及jQuery框架的运用。因此可以保证开发人员的技术可靠性。

   （3）操作可行性：使用方法指导清晰，模块中有图文标志，有计算机使用经验的人皆可使用。

   （4）经济可行性：可以在登录界面插入广告进行推广，从而维持收支平衡或获取收益。

##### 需求分析

   用户特点：任何有网络交友需求的人都可使用

   目标：旨在开发一个新型便捷交友聊天平台，为大家网络交流提供便利。

   功能要求：为用户提供登录注册功能以及群聊私聊功能，并且在聊天中可以发送图片及文件。

性能要求：用户能及时获取其他用户聊天信息并且对浏览器端的新加入用户进行更新。

输出要求：快速展示聊天室界面

输入要求：方便快捷的输入注册登录信息及聊天内容。

安全与保密功能：用户信息只能管理员保管。

兼容性要求：该聊天室可以和其他媒体同步用户名，具有一定的兼容性。

系统维护要求：整个系统管理员可以访问，可以通过访问数据库维护信息等。

需求规定：聊天室用户必须在网页版聊天室登录

##### 系统功能

   将聊天室分为前台和后台两个部分。前台分为用户注册和登录，群聊，上传文件，发送表情包四大模块。后台分为实时更新在线人数、动态更新用户列表，实时确定消息发送时间三大模块。

##### 数据库设计

用户注册信息表

| **表名**    | User（用户表） |      |            |              |
| ----------- | -------------- | ---- | ---------- | ------------ |
| 列名        | 数据类型       | 长度 | 是否可为空 | 描述         |
| Create_data | Data           |      | 否         | 用户注册时间 |
| Password    | Varchar        | 255  | 否         | 用户密码     |
| Username    | Varchar        | 255  | 否         | 用户名       |
| ID          | Int            | 15   | 否         | 用户注册顺序 |

#### 详细设计与实现

实训项目采用前后端分离

后端采用spring boot由控制器返回json数据，前端发送请求，接收到后端的数据后在页面上进行展示。

控制器定义了前端向后端请求数据的路径、格式，经过处理后再向前端返回数据，分别是用户登陆注册控制和文件图片上传下载控制；

定义了文件、消息、用户三个实体类

Repository是数据库接口，本项目只在数据库中存储用户信息，定义了了数据库接口

Service是服务包

定义了两个服务类，文件上传下载和websocket消息传达的具体实现在这两个类中。

前端代码目录结构如下：

配置文件application.yml

（1）登录登录功能

   当用户准备进入聊天室，需输入账号和密码进行验证，验证通过时方可进入聊天界面，不能输入空值，空值由前端进行验证，控制器在数据库中查找用户名密码是否匹配，如果要注册的用户名在数据库中已经存在则给出提示，当账号密码匹配时登陆成功。

（2）聊天功能

   所有用户可以在同一聊天室进行聊天，每个用户可以同步显示其他在线用户发送的消息和发送者的用户名。

核心代码在websocket服务中，核心思想是将所有用户连接后的session保存在一个集合中，发送消息时遍历整个集合，对集合中的每一个session都发送消息：

后端有四个注解：

@OnOpen

@OnClose

@OnMessage

@OnError

分别对应用户连接，用户关闭连接、用户发送消息，服务器错误后端的处理；

当用户连接时需要将session加入集合中，断开连接后将session从集合中移除，后端用list维护一个用户列表，有新用户进入和离开时更新用户列表，在对应的四个注解中进行广播，前端将用户列表动态显示在页面上。

（3）私聊功能

用户可以选择聊天室中任意一个人，发起私聊会话。

私聊功能比较复杂，后端用一个hashmap将用户名和session进行了绑定，确保获取用户名就能得到对应的session进行消息发送，但是由于时间紧任务重，需要前端点击用户后发送用户名，消息类型，消息内容还有前端聊天窗口转换，现在还没做出来。

（4）上传文件功能

用户在聊天过程中 可以选择本地文件进行上传，后端会返回一个该文件的下载地址，用户点击该下载地址即可下载查看该文件。